flowchart TD
    A[LandingVoyado.dbo.ReceiptsLatest] --> B[StageVoyado.dbo.Receipts]
    B --> C[CODW.dbo.SalesTransactionCustomerPreLoad]

    subgraph Pre-processing
        note1[/"Split ExternalId\nâ†’ Date, StoreId, POS, ReceiptNo"/]
        C --> note1
    end

    D[CODW.dbo.Customer]
    E[CODW.dbo.SalesTransaction]

    subgraph Final Bridge Join
        C --> F[CODW.dbo.SalesTransactionCustomer]
        D --> F
        E --> F
        note2[/"Join if both:\n - Customer exists\n - SalesTransaction exists\nFilter: last 2 months"/]
        F --> note2
    end

    style A fill:#e8f0fe,stroke:#3b82f6,stroke-width:1px
    style B fill:#e8f0fe,stroke:#3b82f6,stroke-width:1px
    style C fill:#fef3c7,stroke:#f59e0b,stroke-width:1px
    style D fill:#d1fae5,stroke:#10b981,stroke-width:1px
    style E fill:#d1fae5,stroke:#10b981,stroke-width:1px
    style F fill:#f0fdf4,stroke:#22c55e,stroke-width:2px

    classDef highlight fill:#fff7ed,stroke:#fb923c,stroke-width:2px
    class note1,note2 highlight
